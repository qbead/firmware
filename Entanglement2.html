<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="qbead notification tracker">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>QBead visualiser</title>
        <style>
            #log {
              height: 200px;
              overflow-y: scroll;
              
            }
          </style>
    </head>


        <form>
            <button id="startNotifications">Start connection</button>
            <button id="stopNotifications">Stop connection</button>
        </form>

        <form>
            <button id="measureQB">Measure Qbead</button>
            <!-- <button id="measureQB2">Measure Qbead 2</button> -->
        </form>

        <h3>Output</h3>
        <div id="output" class="output" style="display: inline;">
          <div id="content"></div>
          <div id="status"></div>
          <pre id="log"></pre>
        </div>

        <script>
            var qbeadTracker = {
              log: function() {
                var line = Array.prototype.slice.call(arguments).map(function(argument) {
                  return typeof argument === 'string' ? argument : JSON.stringify(argument);
                }).join(' ');
          
                document.querySelector('#log').textContent = line + '\n';
                document.querySelector('#log').scrollTop = document.querySelector('#log').scrollHeight;
              },
          
              clearLog: function() {
                document.querySelector('#log').textContent = '';
              },
          
              setStatus: function(status) {
                document.querySelector('#status').textContent = status;
              },
          
              setContent: function(newContent) {
                var content = document.querySelector('#content');
                while(content.hasChildNodes()) {
                  content.removeChild(content.lastChild);
                }
                content.appendChild(newContent);
              }
            };
        </script>

        <script>
            var accCharacteristic_1;
            var accCharacteristic_2;       
            let entg=0;
            
            function onStartButtonClick_1() {
                let serviceUuid_1 = "e30c1fc6-359c-12be-2544-63d6aa088d45";
                let accUuid_1 = "e30c1fc9-359c-12be-2544-63d6aa088d45";
                
                log('Requesting Bluetooth Device...');
                navigator.bluetooth.requestDevice(
                    {
                    filters: [{services: [serviceUuid_1]}]
                    }
                )
                .then(device => {
                    log('Connecting to GATT Server...');
                    return device.gatt.connect();
                })
                .then(server => {
                    log('Getting Service...');
                    return server.getPrimaryService(serviceUuid_1);
                })
                .then(service => {
                    log('Getting Characteristics...');
                    //service.getCharacteristic(colUuid).then(ch => {colCharacteristic=ch;});
                    return service.getCharacteristic(accUuid_1);
                })
                .then(characteristic => {
                    accCharacteristic_1 = characteristic;
                    entg=entg+1;
                    //log('Entg value ' + entg);
                    return accCharacteristic_1.startNotifications().then(_ => {
                    log('> Notifications started');
                    log('Entg value '+ entg);
                    entg;
                    log('There are ' + entg + 'Qbead(s) connected')
                    //accCharacteristic.addEventListener('characteristicvaluechanged',
                        //handleNotifications);
                    });
                })
                .catch(error => {
                    log('Argh! ' + error);
                });
            }

            function onStartButtonClick_2() {
                let serviceUuid_2 = "e30c1fc7-359c-12be-2544-63d6aa088d45";
                let accUuid_2 = "e30c1fc8-359c-12be-2544-63d6aa088d45";
                
                log('Requesting Bluetooth Device...');
                navigator.bluetooth.requestDevice(
                    {
                    filters: [{services: [serviceUuid_2]}]
                    }
                )
                .then(device => {
                    log('Connecting to GATT Server...');
                    return device.gatt.connect();
                })
                .then(server => {
                    log('Getting Service...');
                    return server.getPrimaryService(serviceUuid_2);
                })
                .then(service => {
                    log('Getting Characteristics...');
                    //service.getCharacteristic(colUuid).then(ch => {colCharacteristic=ch;});
                    return service.getCharacteristic(accUuid_2);
                })
                .then(characteristic => {
                    accCharacteristic_2 = characteristic;
                    entg=entg+1;
                    //log('Entg value ' + entg);
                    return accCharacteristic_1.startNotifications().then(_ => {
                    log('> Notifications started');
                    log('Entg value '+ entg);
                    entg;
                    log('There is/are ' + entg + ' Qbead(s) connected')
                    //accCharacteristic.addEventListener('characteristicvaluechanged',
                        //handleNotifications);
                    });
                })
                .catch(error => {
                    log('Argh! ' + error);
                });
            }

            function measureQbd() {
                let measure = Math.floor(Math.random() * 2);
                console.log(measure);
                //log(measure_1);

                const data = new Uint8Array([measure]);

                if(measure==0){
                    //log('The observed Qbead has collapsed to State down, while the other Qbead has collapsed to State up!');
                    accCharacteristic_1.writeValue(data);
                    accCharacteristic_2.writeValue(data)
                    .then(() => {
                        log('The observed Qbead has collapsed to State down, while the other Qbead has collapsed to State up!');
                    })
                    .catch(error => {
                        log('Failed to write data: ' + error);
                    });
                }
                if(measure==1){
                    //log('The observed Qbead has collapsed to State up, while the other Qbead has collapsed to State down!');
                    accCharacteristic_1.writeValue(data);
                    accCharacteristic_2.writeValue(data)
                    .then(() => {
                        log('The observed Qbead has collapsed to State up, while the other Qbead has collapsed to State down!');
                    })
                    .catch(error => {
                        log('Failed to write data: ' + error);
                    });
                }
            }


            //function onStopButtonClick() {
            //if (accCharacteristic) {
                //accCharacteristic.stopNotifications()
                //.then(_ => {
                //log('> Notifications stopped');
                //accCharacteristic.removeEventListener('characteristicvaluechanged',
                //    handleNotifications);
                //})
                //.catch(error => {
                //log('Argh! ' + error);
                //});
            //}
            //}
            
            //function onPhiRangeChange() {
            //myDescriptor.writeValue(encoder.encode(value))
            //.then(_ => {
            //    log('> Characteristic User Description changed to: ' + value);
            //})
            //.catch(error => {
            //    log('Argh! ' + error);
            //});
            //}
            //
            //function phi(x, y, z) {
            //let ll = x*x+y*y+z*z;
            //let l = Math.sqrt(ll);
            //let p = Math.atan2(y,x);
            //let t = Math.acos(z/l);
            //return p;
            //}
            //function theta(x, y, z) {
            //let ll = x*x+y*y+z*z;
            //let l = Math.sqrt(ll);
            //let p = Math.atan2(y,x);
            //let t = Math.acos(z/l);
            //return t;
            //}
            
            function handleNotifications(event) {
            new Uint8Array(event.target.value.buffer).reverse();
            let value = event.target.value;
            let z = value.getFloat32(0);
            let y = value.getFloat32(4);
            let x = value.getFloat32(8);
            // Convert raw data bytes to hex values just for the sake of showing something.
            // In the "real" world, you'd use data.getUint8, data.getUint16 or even
            // TextDecoder to process raw data bytes.
            let t = theta(x, y, z)*180/3.14159;
            let p = phi(x, y, z)*180/3.14159;
            window.x = x;
            window.y = y;
            window.z = z;
            log(`> ${x.toFixed(3)} ${y.toFixed(3)} ${z.toFixed(3)} ${t.toFixed(0)} ${p.toFixed(0)} `);
            }

            document.querySelector('#startNotifications').addEventListener('click', function(event) {
              event.stopPropagation();
              event.preventDefault();
              if (isWebBluetoothEnabled() && entg==0) {
                //let entg=0;
                qbeadTracker.clearLog();
                onStartButtonClick_1();
              }
              
              if (isWebBluetoothEnabled() && entg==1){
                qbeadTracker.clearLog();
                onStartButtonClick_2();
              }
            });

            document.querySelector('#measureQB').addEventListener('click', function(event){
                event.stopPropagation();
                event.preventDefault();

                if (isWebBluetoothEnabled() && entg==2){
                qbeadTracker.clearLog();
                //onStartButtonClick_2();
                measureQbd();
              }
            });

            document.querySelector('#stopNotifications').addEventListener('click', function(event) {
              event.stopPropagation();
              event.preventDefault();
              if (isWebBluetoothEnabled()) {
                onStopButtonClick();
              }
            });
            </script>

            <script>
                log = qbeadTracker.log;

                function isWebBluetoothEnabled() {
                  if (navigator.bluetooth) {
                    return true;
                  } else {
                    qbeadTracker.setStatus('Web Bluetooth API is not available.\n' +
                        'Please make sure the "Experimental Web Platform features" flag is enabled.');
                    return false;
                  }
                }
            </script>

    </body>
</html>